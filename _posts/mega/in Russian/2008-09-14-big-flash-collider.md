---
layout: default
categories: [mega, ru]
lang: ru
title: Оптимизируя оптимизированного
slug: big-flash-collider
mainpicture: flashoptimisation.png
tags: flash friends fun information numbers 
postid: 698
---


Воскресным утром я осуществил то, что давно собирался сделать: всерьез взялся за Action Script 3. Разобравшись в синтаксисе и принципах я решил сделать что-то простое и ненавязчивое, но в то же время дающее подергать за самые частые задачи, которые приходится делать, создавая флеш-сайты или флеш-приложения. Ничего сложного в AS3, кроме огромного количества файлов  для любого хоть чуточку серьезного проекта, нет. Мало того, всплыли воспоминания о юности, в которой я стал магистром технических наук и software engineer — дорвавшись до нормального объектно-ориентированного программирования я забыл о еде, питье и вообще почти обо всем.

Теперь о поставленной себе задаче. Вчера за <i>quattro formaggi</i> <a href="http://cssing.org.ua/">Юра</a> рассказал об интересном посте, который он сейчас пишет. Я предложил проиллюстрировать, что одну из описываемых задач оптимальнее всего делать на флеше. Этой задачей я и занялся, сделав флеш-ролик используя AS3. Если бы я писал на AS2, то все заняло бы не более 20 минут. С копанием в устройстве и работе Action Script 3 я справился за 40 минут. Итак, что же я делал.
<!--more-->
На экране есть несколько блоков, они могут располагаться друг за другом таким образом, чтобы всегда оптимально заполнять окно. У них есть максимальная ширина, но они могут изменять ее в меньшую сторону и прыгать со строки на строку. Картинка ниже сделает это объяснение более понятным:



{% figure /o_O/big-flash-collider/sample.jpg %}



Приводить весь первоначальный код не буду, он слишком велик для публикации просто так в посте. Кто хочет, может <a href="http://www.avatarpress.com/darkblue/">Dark Blue</a> Воррена Эллиса (<a href="http://en.wikipedia.org/wiki/Warren_Ellis">Warren Ellis</a>). После прочтения комикса мне захотелось решить какую-нибудь головоломку и я взялся за оптимизацию флеш-ролика. Достигнуть желаемых 1024 байтов мне не удалось, но результат получился удовлетворительный.



## Оптимизация символов

Первым делом я, разумеется, убрал встраивание шрифта, которым показывались цифры. Для этого достаточно и <i>_sans</i>. Само текстовое поле сделал шириной в два символа и удалил единицу, которую написал в нем еще при создании. Половину размера как рукой сняло ;) 

После этого, я избавился от всех групп: вместо размещения блика в группе над нижней плашкой, я поднял его в слой повыше, сэкономив несколько байтов. Везде, где это было возможно, я убрал прозрачность: <i>Alpha: 100%</i> и никаких возражений!



## Оптимизация имен

Следующим шагом стала оптимизация имен. Текстовое поле из <i>txt</i> стало просто <i>t</i>, <i>buttonBackground</i> — <i>b</i> и так далее. Это также сэкономило несколько десятков байтов. Функция <i>arr(e:Event)</i> в файле <i>main.as</i> стала называться просто <i>a(e:Event)</i>. Поскольку она вызывается  при изменении размеров окна <i>listener'ом</i>, это помогло уменьшить размер результирующего swf. Изменения же имен переменных никакого влияния на размер файла не оказали бы.



## Оптимизация исходного кода

Когда оказалось, что во флеше уже менять нечего, я вспомнил как приятно было сдавать экзамен по системному программированию на третьем курсе. Мы проболтали с преподавателем часа три о методах оптимизации программ при компиляции.

Все переменные типа <i>Number</i> я сделал <i>int</i>, после чего убрал ненужные округления. Например, если при подсчете переменной типа <i>Number</i> мне необходимо было указывать
<ol class="h4x0r">
<li><code>var colw:Number=Math.floor(stage.stageWidth/cols);</code></li>
</ol>

то после того, как она стала <i>int</i>, операция / взяла на себя функции целочисленного деления:
<ol class="h4x0r">
<li><code>var colw:int=stage.stageWidth/cols;</code></li>
</ol>

После этого, не задумываясь ни секунды, я вынес повторяющийся кусок с расстановкой блоков в отдельную функцию. Поскольку эта функция вызывается при изменении размеров окна, я записал ее прямо в функцию, вызываемую <i>listener'ом</i>, которую, как мы уже знаем, стали звать <i>a</i>:

<ol class="h4x0r">
<li><code>stage.addEventListener(Event.RESIZE, a);</code></li>
<li><code>…</code></li>
<li><code>function a(e:Event):void {</code></li>
<li><code style="padding-left: 2em;">var cols:int=Math.ceil(stage.stageWidth/300);</code></li>
<li><code style="padding-left: 2em;">var colw:int=stage.stageWidth/cols;</code></li>
<li><code style="padding-left: 2em;">for (var i:int = 0; i &lt; 30; i++) {</code></li>
<li><code style="padding-left: 4em;">var nB:Object=getChildAt(i);</code></li>
<li><code style="padding-left: 4em;">nB.b.width=colw;</code></li>
<li><code style="padding-left: 4em;">nB.x=i%cols*colw;</code></li>
<li><code style="padding-left: 4em;">nB.y=Math.floor(i/cols)*43;</code></li>
<li><code style="padding-left: 2em;">}</code></li>
<li><code>}</code></li>
</ol>

Для вызова этой функции в конструкторе пришлось добавить следующее:
<ol class="h4x0r">
<li><code>var e:Event;</code></li>
<li><code>a(e);</code></li>
</ol>

Эта конструкция добавила 2 байта к размеру swf, но до этого мы сэкономили гораздо больше.

В конце-концов я убрал проверки деления на ноль (флеш даже не поморщился) и скомпилировал проект снова. Юра предостерег меня, чтобы я  не увлекся и не сделал оптимизацию настолько хорошей, что swf станет отрицательного размера. Мир в безопасности: БАК запущен, а файл с отрицательным размером у меня не получился. После всех манипуляций swf стал занимать 1149 байт. Больше в нем оптимизировать нечего. Для сравнения можно <a href='/o_O/big-flash-collider/blocks.zip'>скачать получившийся проект</a> (zip, 12,7 Кбайта). Мне кажется, что оптимизировать там уже нечего ;)